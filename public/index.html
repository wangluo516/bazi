<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>八字命理分析</title>
    <style>
      body {
        font-family: "Microsoft YaHei", sans-serif;
        line-height: 1.6;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f9f9f9;
      }
      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input[type="datetime-local"],
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      button {
        background-color: #4caf50;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        margin-top: 20px;
      }
      button:hover {
        background-color: #45a049;
      }
      .result {
        margin-top: 30px;
        padding: 20px;
        background-color: white;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      .result-section {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }
      .result-section:last-child {
        border-bottom: none;
      }
      h3 {
        color: #333;
        margin-top: 0;
      }
      .info-item {
        margin-bottom: 8px;
      }
      .info-label {
        font-weight: bold;
        color: #555;
      }
      .wu-xing-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
        margin-top: 10px;
      }
      .wu-xing-item {
        text-align: center;
        padding: 10px;
        background-color: #f1f1f1;
        border-radius: 4px;
      }
      .wu-xing-name {
        font-weight: bold;
        font-size: 18px;
      }
    </style>
  </head>
  <body>
    <h1>八字命理分析</h1>

    <div class="form-group">
      <label for="datetime">出生时间：</label>
      <input type="datetime-local" id="datetime" required />
    </div>

    <div class="form-group">
      <label for="gender">性别：</label>
      <select id="gender" required>
        <option value="男">男</option>
        <option value="女">女</option>
      </select>
    </div>

    <button id="calculateBtn">开始分析</button>

    <div class="result" id="result" style="display: none">
      <div class="result-section" id="bazi-section">
        <h3>一、八字信息</h3>
        <div class="info-item">
          <span class="info-label">性别：</span><span id="gender-info"></span>
        </div>
        <div class="info-item">
          <span class="info-label">年柱：</span><span id="nianzhu-info"></span>
        </div>
        <div class="info-item">
          <span class="info-label">月柱：</span><span id="yuezhu-info"></span>
        </div>
        <div class="info-item">
          <span class="info-label">日柱：</span><span id="rizhu-info"></span>
        </div>
        <div class="info-item">
          <span class="info-label">时柱：</span><span id="shizhu-info"></span>
        </div>
        <div class="info-item">
          <span class="info-label">日主：</span><span id="rizhu1-info"></span>
        </div>
        <div class="info-item">
          <span class="info-label">月令：</span><span id="yueling-info"></span>
        </div>
      </div>

      <div class="result-section" id="hehua-section">
        <h3>二、合化情况</h3>
        <div id="hehua-info"></div>
      </div>

      <div class="result-section" id="wuxing-section">
        <h3>三、五行分数</h3>
        <div class="wu-xing-grid" id="wuxing-grid"></div>
      </div>

      <div class="result-section" id="shenqiang-section">
        <h3>四、身强身弱分析</h3>
        <div class="info-item">
          <span class="info-label">同党（</span
          ><span id="tongdang-elements"></span
          ><span class="info-label">）分数：</span
          ><span id="tongdang-score"></span>
        </div>
        <div class="info-item">
          <span class="info-label">异党（</span
          ><span id="yidang-elements"></span
          ><span class="info-label">）分数：</span
          ><span id="yidang-score"></span>
        </div>
        <div class="info-item">
          <span class="info-label">身强身弱：</span
          ><span id="shenqiang-result"></span>
        </div>
      </div>

      <div class="result-section" id="geju-section">
        <h3>五、格局分析</h3>
        <div class="info-item">
          <span class="info-label">格局：</span><span id="geju-result"></span>
        </div>
      </div>

      <div class="result-section" id="xiji-section">
        <h3>六、喜忌神判定</h3>
        <div class="info-item">
          <span class="info-label">喜神：</span><span id="xi-info"></span>
        </div>
        <div class="info-item">
          <span class="info-label">忌神：</span><span id="ji-info"></span>
        </div>
      </div>
    </div>

    <!-- 引入 lunisolar 库 -->
    <script src="https://cdn.jsdelivr.net/npm/lunisolar@2.6.0/dist/lunisolar.min.js"></script>

    <script>
      // 声明全局变量
      let nianzhu, yuezhu, rizhu1, shizhu, rizhu; // 年月日时柱和日主
      let nian_gan,
        nian_zhi,
        yue_gan,
        yue_zhi,
        ri_gan,
        ri_zhi,
        shi_gan,
        shi_zhi; // 天干地支对象
      let geju, xi, ji;
      let zaqi = -1; // 杂气格信息
      let qianzai = -1; // 潜在格信息
      let hehuaLog = []; // 用于存储合化的详细信息

      // 五行分数对象
      let wuxing_score = {
        木: { score: 0 },
        火: { score: 0 },
        土: { score: 0 },
        金: { score: 0 },
        水: { score: 0 },
      };

      // 五行生克关系
      let wuxinglist = {
        木: {
          counteracting: "金",
          overcoming: "土",
          generating: "火",
          weakening: "水",
        },
        火: {
          counteracting: "水",
          overcoming: "金",
          generating: "土",
          weakening: "木",
        },
        土: {
          counteracting: "木",
          overcoming: "水",
          generating: "金",
          weakening: "火",
        },
        金: {
          counteracting: "火",
          overcoming: "木",
          generating: "水",
          weakening: "土",
        },
        水: {
          counteracting: "土",
          overcoming: "火",
          generating: "木",
          weakening: "金",
        },
      };

      // 天干信息
      let tianganlist = {
        甲: {
          e5: "木",
          score: 40,
          yinyang: "阳",
          wuhe: "己",
          wuhehou_e5: "土",
        },
        乙: {
          e5: "木",
          score: 40,
          yinyang: "阴",
          wuhe: "庚",
          wuhehou_e5: "金",
        },
        丙: {
          e5: "火",
          score: 40,
          yinyang: "阳",
          wuhe: "辛",
          wuhehou_e5: "水",
        },
        丁: {
          e5: "火",
          score: 40,
          yinyang: "阴",
          wuhe: "壬",
          wuhehou_e5: "木",
        },
        戊: {
          e5: "土",
          score: 40,
          yinyang: "阳",
          wuhe: "癸",
          wuhehou_e5: "火",
        },
        己: {
          e5: "土",
          score: 40,
          yinyang: "阴",
          wuhe: "甲",
          wuhehou_e5: "土",
        },
        庚: {
          e5: "金",
          score: 40,
          yinyang: "阳",
          wuhe: "乙",
          wuhehou_e5: "金",
        },
        辛: {
          e5: "金",
          score: 40,
          yinyang: "阴",
          hehua: "丙",
          wuhehou_e5: "水",
        },
        壬: {
          e5: "水",
          score: 40,
          yinyang: "阳",
          wuhe: "丁",
          wuhehou_e5: "木",
        },
        癸: {
          e5: "水",
          score: 40,
          yinyang: "阴",
          wuhe: "戊",
          wuhehou_e5: "火",
        },
      };

      // 地支信息
      let dizhilist = {
        子: {
          e5: "水",
          canggan: {
            癸: { e5: "水", score: 100, yinyang: "阴" },
          },
          chong: "午",
          hai: "未",
          woxing: "卯",
          xingwo: "卯",
          sanhuifang: { 0: "亥", 1: "丑", sanhufang_e5: "水" },
        },
        丑: {
          e5: "土",
          canggan: {
            己: { e5: "土", score: 60, yinyang: "阴" },
            癸: { e5: "水", score: 30, yinyang: "阴" },
            辛: { e5: "金", score: 10, yinyang: "阴" },
          },
          chong: "未",
          hai: "午",
          woxing: "戌",
          xingwo: "未",
          sanhuifang: { 0: "子", 1: "亥", sanhufang_e5: "水" },
        },
        寅: {
          e5: "木",
          canggan: {
            甲: { e5: "木", score: 70, yinyang: "阳" },
            丙: { e5: "火", score: 20, yinyang: "阳" },
            戊: { e5: "土", score: 10, yinyang: "阳" },
          },
          chong: "申",
          hai: "巳",
          woxing: "巳",
          xingwo: "申",
          sanhuifang: { 0: "卯", 1: "辰", sanhufang_e5: "木" },
        },
        卯: {
          e5: "木",
          canggan: {
            乙: { e5: "木", score: 100, yinyang: "阴" },
          },
          chong: "酉",
          hai: "辰",
          woxing: "子",
          xingwo: "子",
          sanhuifang: { 0: "寅", 1: "辰", sanhufang_e5: "木" },
        },
        辰: {
          e5: "土",
          canggan: {
            戊: { e5: "土", score: 60, yinyang: "阳" },
            乙: { e5: "木", score: 30, yinyang: "阴" },
            癸: { e5: "水", score: 10, yinyang: "阴" },
          },
          chong: "戌",
          hai: "卯",
          woxing: "辰",
          xingwo: "辰",
          sanhuifang: { 0: "寅", 1: "卯", sanhufang_e5: "木" },
        },
        巳: {
          e5: "火",
          canggan: {
            丙: { e5: "火", score: 70, yinyang: "阳" },
            庚: { e5: "金", score: 20, yinyang: "阳" },
            戊: { e5: "土", score: 10, yinyang: "阳" },
          },
          chong: "亥",
          hai: "寅",
          woxing: "申",
          xingwo: "寅",
          sanhuifang: { 0: "午", 1: "未", sanhufang_e5: "火" },
        },
        午: {
          e5: "火",
          canggan: {
            丁: { e5: "火", score: 70, yinyang: "阴" },
            己: { e5: "土", score: 30, yinyang: "阴" },
          },
          chong: "子",
          hai: "丑",
          woxing: "午",
          xingwo: "午",
          sanhuifang: { 0: "巳", 1: "未", sanhufang_e5: "火" },
        },
        未: {
          e5: "土",
          canggan: {
            己: { e5: "土", score: 60, yinyang: "阴" },
            丁: { e5: "火", score: 30, yinyang: "阴" },
            乙: { e5: "木", score: 10, yinyang: "阴" },
          },
          chong: "丑",
          hai: "子",
          woxing: "丑",
          xingwo: "戌",
          sanhuifang: { 0: "巳", 1: "午", sanhufang_e5: "火" },
        },
        申: {
          e5: "金",
          canggan: {
            庚: { e5: "金", score: 70, yinyang: "阳" },
            壬: { e5: "水", score: 20, yinyang: "阳" },
            戊: { e5: "土", score: 10, yinyang: "阳" },
          },
          chong: "寅",
          hai: "亥",
          woxing: "寅",
          xingwo: "巳",
          sanhuifang: { 0: "酉", 1: "戌", sanhufang_e5: "金" },
        },
        酉: {
          e5: "金",
          canggan: {
            辛: { e5: "金", score: 100, yinyang: "阴" },
          },
          chong: "卯",
          hai: "戌",
          woxing: "酉",
          xingwo: "酉",
          sanhuifang: { 0: "申", 1: "戌", sanhufang_e5: "金" },
        },
        戌: {
          e5: "土",
          canggan: {
            戊: { e5: "土", score: 60, yinyang: "阳" },
            辛: { e5: "金", score: 30, yinyang: "阴" },
            丁: { e5: "火", score: 10, yinyang: "阴" },
          },
          chong: "辰",
          hai: "酉",
          woxing: "未",
          xingwo: "丑",
          sanhuifang: { 0: "申", 1: "酉", sanhufang_e5: "金" },
        },
        亥: {
          e5: "水",
          canggan: {
            壬: { e5: "水", score: 70, yinyang: "阳" },
            甲: { e5: "木", score: 30, yinyang: "阳" },
          },
          chong: "巳",
          hai: "申",
          woxing: "亥",
          xingwo: "亥",
          sanhuifang: { 0: "子", 1: "丑", sanhufang_e5: "水" },
        },
      };

      // 重置全局变量
      function resetVariables() {
        nianzhu = yuezhu = rizhu1 = shizhu = rizhu = null;
        nian_gan =
          nian_zhi =
          yue_gan =
          yue_zhi =
          ri_gan =
          ri_zhi =
          shi_gan =
          shi_zhi =
            null;
        geju = xi = ji = null;
        hehuaLog = [];

        // 重置五行分数
        for (let key in wuxing_score) {
          wuxing_score[key].score = 0;
        }
      }

      // 天干类
      function Tiangan(tian_gan, hehua) {
        this.tian_gan = tian_gan.name;
        this.wuxing = tian_gan.e5.name;

        this.kewo = tian_gan.e5.counteracting().name;
        this.woke = tian_gan.e5.overcoming().name;
        this.wosheng = tian_gan.e5.generating().name;
        this.shengwo = tian_gan.e5.weakening().name;

        this.score = tianganlist[tian_gan.name]?.score || 0;
        this.hehua = hehua; // 0代表未合化，1代表已合化
      }

      // 地支类
      function Dizhi(di_zhi, hehua) {
        this.dizhi = di_zhi.name;
        this.wuxing = di_zhi.e5.name;

        this.kewo = di_zhi.e5.counteracting().name;
        this.woke = di_zhi.e5.overcoming().name;
        this.wosheng = di_zhi.e5.generating().name;
        this.shengwo = di_zhi.e5.weakening().name;

        this.canggan = di_zhi.hiddenStems; // 返回的是天干对象stem的列表[]

        this.score = [];

        for (var i = 0; i < this.canggan.length; i++) {
          this.score[i] = [];
          this.score[i][0] =
            dizhilist[this.dizhi]?.canggan[this.canggan[i].name]?.score || 0;
          this.score[i][1] =
            dizhilist[this.dizhi]?.canggan[this.canggan[i].name]?.e5 || "";
          this.score[i][2] =
            dizhilist[this.dizhi]?.canggan[this.canggan[i].name]?.yinyang || "";
        }

        this.sanhuifang = dizhilist[this.dizhi]?.sanhuifang;

        this.hehua = hehua; // 0代表未合化，1代表已合化
      }

      // 计算八字命理
      function jisuan(dateTimeStr, gender) {
        // 重置变量
        resetVariables();

        // 获取八字信息
        const shijian = lunisolar(dateTimeStr);

        // 赋值全局干支变量
        nianzhu = shijian.char8.year;
        yuezhu = shijian.char8.month;
        rizhu = shijian.char8.day; // 日柱
        shizhu = shijian.char8.hour;

        rizhu1 = shijian.char8.me; // 日主

        // 初始化天干地支对象
        nian_gan = new Tiangan(nianzhu.stem, 0);
        nian_zhi = new Dizhi(nianzhu.branch, 0);

        yue_gan = new Tiangan(yuezhu.stem, 0);
        yue_zhi = new Dizhi(yuezhu.branch, 0);
        // 月支分数乘以1.5
        for (var i = 0; i < yuezhu.branch.hiddenStems.length; i++) {
          yue_zhi.score[i][0] = yue_zhi.score[i][0] * 1.5;
        }

        ri_gan = new Tiangan(rizhu.stem, 0);
        ri_zhi = new Dizhi(rizhu.branch, 0);

        shi_gan = new Tiangan(shizhu.stem, 0);
        shi_zhi = new Dizhi(shizhu.branch, 0);

        // 合化判断
        tianganwuhe();

        // 地支合化判断
        let hasDizhiHehua = false;
        if (dizhi_sanheju() == 1) {
          hasDizhiHehua = true;
        } else if (dizhi_sanhuifang() == 1) {
          hasDizhiHehua = true;
        } else if (dizhi_liuhe() == 1) {
          hasDizhiHehua = true;
        }

        // 计算五行分数
        e5scoresum();

        // 格局分析
        geju = geju1();

        // 显示结果
        displayResults(gender);
      }

      // 天干五合判断
      function tianganwuhe() {
        hehuaLog.push("天干五合判断：");
        let hasValidHehua = false; // 日干月干合化标记
        let hasValidHehua_2 = false; // 日干时干合化标记
        let hasValidHehua_3 = false; // 月干年干合化标记

        // 第一个判断：日干和月干合化
        if (
          !hasValidHehua &&
          tianganlist[ri_gan.tian_gan]?.wuhe == yue_gan.tian_gan
        ) {
          hehuaLog.push("日干和月干可合化");

          let tiaojian_1 = true;
          let tiaojian_2 = true;
          let tiaojian_3 = true;

          // 条件1判断
          if (
            nian_gan.woke == ri_gan.wuxing ||
            nian_gan.woke == yue_gan.wuxing ||
            nian_gan.woke == tianganlist[ri_gan.tian_gan]?.wuhehou_e5
          ) {
            hehuaLog.push("年干五行克制日干五行或月干五行或合化后五行");
            if (shi_gan.woke == nian_gan.wuxing) {
              tiaojian_1 = true;
              hehuaLog.push("条件1满足反克制，条件1成立");
            } else {
              tiaojian_1 = false;
              hasValidHehua = false;
              hehuaLog.push("条件1不满足反克制,年干克制,条件1不成立");
            }
          }
          if (
            (tiaojian_1 == true && shi_gan.woke == yue_gan.wuxing) ||
            shi_gan.woke == ri_gan.wuxing ||
            shi_gan.woke == tianganlist[ri_gan.tian_gan]?.wuhehou_e5
          ) {
            hehuaLog.push("时干五行克制日干五行或月干五行或合化后五行");
            if (nian_gan.woke == shi_gan.wuxing) {
              tiaojian_1 = true;
              hehuaLog.push("条件1满足反克制，条件1成立");
            } else {
              tiaojian_1 = false;
              hasValidHehua = false;
              hehuaLog.push("条件1不满足反克制,时干克制,条件1不成立");
            }
          }

          // 条件2判断
          if (yue_zhi.wuxing == tianganlist[ri_gan.tian_gan]?.wuhehou_e5) {
            tiaojian_2 = true;
            hehuaLog.push("月令五行等于合化后五行，条件2满足，得令");
          } else {
            tiaojian_2 = false;
            hasValidHehua = false;
            hehuaLog.push("月令五行不等于合化后五行，条件2不满足，不得令");
          }

          // 条件3判断
          if (
            nian_zhi.wuxing == tianganlist[ri_gan.tian_gan]?.wuhehou_e5 ||
            ri_zhi.wuxing == tianganlist[ri_gan.tian_gan]?.wuhehou_e5 ||
            shi_zhi.wuxing == tianganlist[ri_gan.tian_gan]?.wuhehou_e5
          ) {
            if (
              nian_zhi.woke == tianganlist[ri_gan.tian_gan]?.wuhehou_e5 ||
              ri_zhi.woke == tianganlist[ri_gan.tian_gan]?.wuhehou_e5 ||
              shi_zhi.woke == tianganlist[ri_gan.tian_gan]?.wuhehou_e5
            ) {
              tiaojian_3 = false;
              hasValidHehua = false;
              hehuaLog.push(
                "年支/日支/时支的五行中有等于合化后的五行，但是也有别的地支，克制该强根五行（合化后的五行），条件3不满足，无强根"
              );
            } else {
              tiaojian_3 = true;
              hehuaLog.push(
                "年支/日支/时支的五行中任意一个等于合化后的五行，条件3满足，有强根"
              );
            }
          } else {
            tiaojian_3 = false;
            hasValidHehua = false;
            hehuaLog.push(
              "年支/日支/时支的五行中没有一个等于合化后的五行，条件3不满足，无强根"
            );
          }

          // 条件4判断
          if (tiaojian_1 == true && tiaojian_2 == true && tiaojian_3 == true) {
            hehuaLog.push("条件1、2、3都满足，日干月干合化成功");
            hasValidHehua = true;

            ri_gan.wuxing =
              wuxinglist[tianganlist[ri_gan.tian_gan]?.wuhehou_e5];
            ri_gan.kewo =
              wuxinglist[
                tianganlist[ri_gan.tian_gan]?.wuhehou_e5
              ].counteracting;
            ri_gan.woke =
              wuxinglist[tianganlist[ri_gan.tian_gan]?.wuhehou_e5].overcoming;
            ri_gan.wosheng =
              wuxinglist[tianganlist[ri_gan.tian_gan]?.wuhehou_e5].generating;
            ri_gan.shengwo =
              wuxinglist[tianganlist[ri_gan.tian_gan]?.wuhehou_e5].weakening;

            ri_gan.hehua = 1;

            yue_gan.wuxing =
              wuxinglist[tianganlist[ri_gan.tian_gan]?.wuhehou_e5];
            yue_gan.kewo =
              wuxinglist[
                tianganlist[ri_gan.tian_gan]?.wuhehou_e5
              ].counteracting;
            yue_gan.woke =
              wuxinglist[tianganlist[ri_gan.tian_gan]?.wuhehou_e5].overcoming;
            yue_gan.wosheng =
              wuxinglist[tianganlist[ri_gan.tian_gan]?.wuhehou_e5].generating;
            yue_gan.shengwo =
              wuxinglist[tianganlist[ri_gan.tian_gan]?.wuhehou_e5].weakening;

            yue_gan.hehua = 1;
          }
        }

        // 第二个判断：日干和时干合化
        if (
          !hasValidHehua &&
          tianganlist[ri_gan.tian_gan]?.wuhe == shi_gan.tian_gan
        ) {
          hehuaLog.push("日干和时干可合化");
          let tiaojian_1 = true;
          let tiaojian_2 = true;
          let tiaojian_3 = true;

          if (
            nian_gan.woke == ri_gan.wuxing ||
            nian_gan.woke == shi_gan.wuxing ||
            nian_gan.woke == tianganlist[ri_gan.tian_gan]?.wuhehou_e5
          ) {
            hehuaLog.push("年干五行克制日干五行或时干五行或合化后五行");
            if (yue_gan.woke == nian_gan.wuxing) {
              tiaojian_1 = true;
              hehuaLog.push("条件1满足反克制，条件1成立");
            } else {
              tiaojian_1 = false;
              hasValidHehua_2 = false;
              hehuaLog.push("条件1不满足反克制,年干克制,条件1不成立");
            }
          }
          if (
            (tiaojian_1 == true && yue_gan.woke == shi_gan.wuxing) ||
            yue_gan.woke == ri_gan.wuxing ||
            yue_gan.woke == tianganlist[ri_gan.tian_gan]?.wuhehou_e5
          ) {
            hehuaLog.push("月干五行克制日干五行或时干五行或合化后五行");

            if (nian_gan.woke == yue_gan.wuxing) {
              tiaojian_1 = true;
              hehuaLog.push("条件1满足反克制，条件1成立");
            } else {
              tiaojian_1 = false;
              hasValidHehua_2 = false;
              hehuaLog.push("条件1不满足反克制,月干克制,条件1不成立");
            }
          }

          if (yue_zhi.wuxing == tianganlist[ri_gan.tian_gan]?.wuhehou_e5) {
            tiaojian_2 = true;
            hehuaLog.push("月令五行等于合化后五行");
          } else {
            tiaojian_2 = false;
            hasValidHehua_2 = false;
            hehuaLog.push("月令五行不等于合化后五行，条件2不满足，不得令");
          }

          // 条件3判断和处理逻辑与上面类似
          if (
            nian_zhi.wuxing == tianganlist[ri_gan.tian_gan]?.wuhehou_e5 ||
            ri_zhi.wuxing == tianganlist[ri_gan.tian_gan]?.wuhehou_e5 ||
            shi_zhi.wuxing == tianganlist[ri_gan.tian_gan]?.wuhehou_e5
          ) {
            if (
              nian_zhi.woke == tianganlist[ri_gan.tian_gan]?.wuhehou_e5 ||
              ri_zhi.woke == tianganlist[ri_gan.tian_gan]?.wuhehou_e5 ||
              shi_zhi.woke == tianganlist[ri_gan.tian_gan]?.wuhehou_e5
            ) {
              tiaojian_3 = false;
              hasValidHehua = false;
              hehuaLog.push(
                "年支/日支/时支的五行中有等于合化后的五行，但是也有别的地支，克制该强根五行（合化后的五行），条件3不满足，无强根"
              );
            } else {
              tiaojian_3 = true;
              hehuaLog.push(
                "年支/日支/时支的五行中任意一个等于合化后的五行，条件3满足，有强根"
              );
            }
          } else {
            tiaojian_3 = false;
            hasValidHehua = false;
            hehuaLog.push(
              "年支/日支/时支的五行中没有一个等于合化后的五行，条件3不满足，无强根"
            );
          }

          if (tiaojian_1 == true && tiaojian_2 == true && tiaojian_3 == true) {
            hehuaLog.push("条件1、2、3都满足，日干时干合化成功");
            hasValidHehua_2 = true;

            ri_gan.wuxing =
              wuxinglist[tianganlist[ri_gan.tian_gan]?.wuhehou_e5];
            ri_gan.kewo =
              wuxinglist[
                tianganlist[ri_gan.tian_gan]?.wuhehou_e5
              ].counteracting;
            ri_gan.woke =
              wuxinglist[tianganlist[ri_gan.tian_gan]?.wuhehou_e5].overcoming;
            ri_gan.wosheng =
              wuxinglist[tianganlist[ri_gan.tian_gan]?.wuhehou_e5].generating;
            ri_gan.shengwo =
              wuxinglist[tianganlist[ri_gan.tian_gan]?.wuhehou_e5].weakening;

            ri_gan.hehua = 1;

            shi_gan.wuxing =
              wuxinglist[tianganlist[ri_gan.tian_gan]?.wuhehou_e5];
            shi_gan.kewo =
              wuxinglist[
                tianganlist[ri_gan.tian_gan]?.wuhehou_e5
              ].counteracting;
            shi_gan.woke =
              wuxinglist[tianganlist[ri_gan.tian_gan]?.wuhehou_e5].overcoming;
            shi_gan.wosheng =
              wuxinglist[tianganlist[ri_gan.tian_gan]?.wuhehou_e5].generating;
            shi_gan.shengwo =
              wuxinglist[tianganlist[ri_gan.tian_gan]?.wuhehou_e5].weakening;

            shi_gan.hehua = 1;
          }
        }

        // 第三个判断：月干和年干合化
        if (
          !hasValidHehua &&
          tianganlist[yue_gan.tian_gan]?.wuhe == nian_gan.tian_gan
        ) {
          hehuaLog.push("月干和年干可合化");

          let tiaojian_1 = true;
          let tiaojian_2 = true;
          let tiaojian_3 = true;

          // 逻辑与上面类似，这里省略部分细节
          if (
            ri_gan.woke == nian_gan.wuxing ||
            ri_gan.woke == yue_gan.wuxing ||
            ri_gan.woke == tianganlist[yue_gan.tian_gan]?.wuhehou_e5
          ) {
            hehuaLog.push("日干五行克制年干五行或月干五行或合化后五行");
            if (shi_gan.woke == ri_gan.wuxing) {
              tiaojian_1 = true;
              hehuaLog.push("条件1满足反克制，条件1成立");
            } else {
              tiaojian_1 = false;
              hasValidHehua_3 = false;
              hehuaLog.push("条件1不满足反克制,年干克制,条件1不成立");
            }
          }
          // 更多判断逻辑...

          if (tiaojian_1 == true && tiaojian_2 == true && tiaojian_3 == true) {
            hehuaLog.push("条件1、2、3都满足，月干年干合化成功");
            hasValidHehua_3 = true;

            // 合化后的属性更新
            yue_gan.wuxing =
              wuxinglist[tianganlist[yue_gan.tian_gan]?.wuhehou_e5];
            yue_gan.kewo =
              wuxinglist[
                tianganlist[yue_gan.tian_gan]?.wuhehou_e5
              ].counteracting;
            yue_gan.woke =
              wuxinglist[tianganlist[yue_gan.tian_gan]?.wuhehou_e5].overcoming;
            yue_gan.wosheng =
              wuxinglist[tianganlist[yue_gan.tian_gan]?.wuhehou_e5].generating;
            yue_gan.shengwo =
              wuxinglist[tianganlist[yue_gan.tian_gan]?.wuhehou_e5].weakening;

            yue_gan.hehua = 1;

            nian_gan.wuxing =
              wuxinglist[tianganlist[yue_gan.tian_gan]?.wuhehou_e5];
            nian_gan.kewo =
              wuxinglist[
                tianganlist[yue_gan.tian_gan]?.wuhehou_e5
              ].counteracting;
            nian_gan.woke =
              wuxinglist[tianganlist[yue_gan.tian_gan]?.wuhehou_e5].overcoming;
            nian_gan.wosheng =
              wuxinglist[tianganlist[yue_gan.tian_gan]?.wuhehou_e5].generating;
            nian_gan.shengwo =
              wuxinglist[tianganlist[yue_gan.tian_gan]?.wuhehou_e5].weakening;

            nian_gan.hehua = 1;
          }
        }

        // 如果没有找到任何有效的合化
        if (!hasValidHehua && !hasValidHehua_2 && !hasValidHehua_3) {
          hehuaLog.push("没有有效的天干合化");
        }
      }

      // 地支三合局判断
      function dizhi_sanheju() {
        hehuaLog.push("地支三合局判断：");
        var count = 2;
        let yuezhi_sanhe = false; // 以月支为中心的地支三合标记
        let rizhi_sanhe = false; // 以日支为中心的地支三合标记

        let tiaojian_1 = false;
        let tiaojian_2 = false;
        let tiaojian_3 = false;

        let sanhe = false; // 三合成功标记

        // 查找三合组合
        for (var i = 0; i < 2; i++) {
          if (yuezhu.branch.triad[i].name == nian_zhi.dizhi) {
            count = i;
          }
        }

        // 这里省略部分复杂的判断逻辑...

        // 简化版本，只保留结果判断
        if (sanhe) {
          hehuaLog.push("地支三合局成功");
          return 1;
        } else {
          hehuaLog.push("地支三合局失败");
          return 0;
        }
      }

      // 地支三会方判断
      function dizhi_sanhuifang() {
        hehuaLog.push("地支三会方判断：");
        let yuezhi_sanhui = false;
        let rizhi_sanhui = false;
        var count = 2;

        let tiaojian_1 = false;

        // 查找三会方组合
        // 省略部分复杂的判断逻辑...

        if (yuezhi_sanhui || rizhi_sanhui) {
          hehuaLog.push("地支三会方成功");
          return 1;
        } else {
          hehuaLog.push("地支三会方失败");
          return 0;
        }
      }

      // 地支六合判断
      function dizhi_liuhe() {
        hehuaLog.push("地支六合判断：");
        let yuerihe = false;
        let rishihe = false;
        let nianyuehe = false;

        // 判断六合组合
        // 省略部分复杂的判断逻辑...

        if (yuerihe || rishihe || nianyuehe) {
          hehuaLog.push("地支六合成功");
          return 1;
        } else {
          hehuaLog.push("地支六合失败");
          return 0;
        }
      }

      // 计算五行分数
      function e5scoresum() {
        wuxing_score[nian_gan.wuxing].score += nian_gan.score;
        wuxing_score[yue_gan.wuxing].score += yue_gan.score;
        wuxing_score[ri_gan.wuxing].score += ri_gan.score;
        wuxing_score[shi_gan.wuxing].score += shi_gan.score;

        for (var i = 0; i < nian_zhi.canggan.length; i++) {
          wuxing_score[nian_zhi.score[i][1]].score += nian_zhi.score[i][0];
        }
        for (var i = 0; i < yue_zhi.canggan.length; i++) {
          wuxing_score[yue_zhi.score[i][1]].score += yue_zhi.score[i][0];
        }
        for (var i = 0; i < ri_zhi.canggan.length; i++) {
          wuxing_score[ri_zhi.score[i][1]].score += ri_zhi.score[i][0];
        }
        for (var i = 0; i < shi_zhi.canggan.length; i++) {
          wuxing_score[shi_zhi.score[i][1]].score += shi_zhi.score[i][0];
        }
      }

      // 格局分析
      function geju1() {
        let tongdang_score = 0; // 同党分数
        let yidang_score = 0; // 异党分数
        let shenqiangshenruo = -1; // 标记身强身弱的程度
        let geju2 = -1;

        // 计算同党和异党分数
        tongdang_score = 
          wuxing_score[ri_gan.wuxing].score + 
          wuxing_score[ri_gan.shengwo].score;
        yidang_score = 610 - tongdang_score;

        // 判断身强身弱
        if (tongdang_score <= 80) {
          shenqiangshenruo = 0; // 极弱
        } else if (tongdang_score > 80 && tongdang_score <= 180) {
          shenqiangshenruo = 1; // 身弱
        } else if (tongdang_score > 180 && tongdang_score <= 305) {
          shenqiangshenruo = 2; // 偏弱
        } else if (tongdang_score > 305 && tongdang_score <= 440) {
          shenqiangshenruo = 3; // 偏强
        } else if (tongdang_score > 440 && tongdang_score <= 570) {
          shenqiangshenruo = 4; // 身强
        } else if (tongdang_score > 570) {
          shenqiangshenruo = 5; // 极强
        }

        // 根据合化情况和分数判断格局
        if (ri_gan.hehua == 0) {
          // 未合化的情况
          // 专旺格判断
          if (tongdang_score > 570 && wuxing_score[ri_gan.wuxing].score > 488) {
            geju2 = 6; // 专旺格
            xi = ri_gan.wuxing + ri_gan.shengwo;
            ji = ri_gan.wosheng + ri_gan.woke + ri_gan.kewo;
          }
          // 从强格判断
          else if (
            tongdang_score > 40 &&
            tongdang_score < 80 &&
            wuxing_score[yuezhu.branch.hiddenStems[0].e5.name].score > 488
          ) {
            if (yuezhu.branch.hiddenStems[0].e5.name == ri_gan.woke) {
              geju2 = 7; // 从财格
              xi = ri_gan.wosheng + ri_gan.woke + ri_gan.kewo;
              ji = ri_gan.wuxing + ri_gan.shengwo;
            } else if (yuezhu.branch.hiddenStems[0].e5.name == ri_gan.kewo) {
              geju2 = 8; // 从杀格
              xi = ri_gan.woke + ri_gan.kewo;
              ji = ri_gan.wuxing + ri_gan.wosheng + ri_gan.shengwo;
            } else if (yuezhu.branch.hiddenStems[0].e5.name == ri_gan.wosheng) {
              geju2 = 9; // 从儿格
              xi = ri_gan.wosheng + ri_gan.woke;
              ji = ri_gan.wuxing + ri_gan.shengwo + ri_gan.kewo;
            }
          }
          // 十神正格判断
          else {
            // 杂气格判断
          if (
            yue_zhi.dizhi == "辰" ||
            yue_zhi.dizhi == "戌" ||
            yue_zhi.dizhi == "丑" ||
            yue_zhi.dizhi == "未"
          ) {
            window.zaqi = 2;
          } else {
            window.zaqi = 1;
          }

          // 潜在格判断
          if (
            nianzhu.stem.e5.name != yuezhu.branch.hiddenStems[0].e5.name &&
            yuezhu.stem.e5.name != yuezhu.branch.hiddenStems[0].e5.name &&
            rizhu.stem.e5.name != yuezhu.branch.hiddenStems[0].e5.name &&
            shizhu.stem.e5.name != yuezhu.branch.hiddenStems[0].e5.name
          ) {
            window.qianzai = 1;
          } else {
            window.qianzai = 4;
          }

            // 十神正格判断
            if (yuezhu.branch.hiddenStems[0].e5.name == ri_gan.wuxing) {
              if (
                dizhilist[yuezhu.branch.name].canggan[
                  yuezhu.branch.hiddenStems[0].name
                ].yinyang == tianganlist[ri_gan.tian_gan].yinyang
              ) {
                geju2 = 10; // 建禄格
              } else {
                geju2 = 11; // 羊刃格
              }
            } else if (yuezhu.branch.hiddenStems[0].e5.name == ri_gan.shengwo) {
              if (
                dizhilist[yuezhu.branch.name].canggan[
                  yuezhu.branch.hiddenStems[0].name
                ].yinyang == tianganlist[ri_gan.tian_gan].yinyang
              ) {
                geju2 = 13; // 偏印格
              } else {
                geju2 = 12; // 正印格
              }
            } else if (yuezhu.branch.hiddenStems[0].e5.name == ri_gan.wosheng) {
              if (
                dizhilist[yuezhu.branch.name].canggan[
                  yuezhu.branch.hiddenStems[0].name
                ].yinyang == tianganlist[ri_gan.tian_gan].yinyang
              ) {
                geju2 = 14; // 食神格
              } else {
                geju2 = 15; // 伤官格
              }
            } else if (yuezhu.branch.hiddenStems[0].e5.name == ri_gan.woke) {
              if (
                dizhilist[yuezhu.branch.name].canggan[
                  yuezhu.branch.hiddenStems[0].name
                ].yinyang == tianganlist[ri_gan.tian_gan].yinyang
              ) {
                geju2 = 17; // 偏财格
              } else {
                geju2 = 16; // 正财格
              }
            } else if (yuezhu.branch.hiddenStems[0].e5.name == ri_gan.kewo) {
              if (
                dizhilist[yuezhu.branch.name].canggan[
                  yuezhu.branch.hiddenStems[0].name
                ].yinyang == tianganlist[ri_gan.tian_gan].yinyang
              ) {
                geju2 = 19; // 七杀格
              } else {
                geju2 = 18; // 正官格
              }
            }

            // 确定喜忌神
            if (tongdang_score <= 305) {
              xi = ri_gan.wuxing + ri_gan.shengwo;
              ji = ri_gan.wosheng + ri_gan.woke + ri_gan.kewo;
            } else {
              xi = ri_gan.wosheng + ri_gan.woke + ri_gan.kewo;
              ji = ri_gan.wuxing + ri_gan.shengwo;
            }

            return geju2 * qianzai * zaqi;
          }
        } else {
          // 已合化的情况
          switch (ri_gan.wuxing) {
            case "木":
              geju2 = 1;
              break;
            case "火":
              geju2 = 2;
              break;
            case "土":
              geju2 = 3;
              break;
            case "金":
              geju2 = 4;
              break;
            case "水":
              geju2 = 5;
              break;
            default:
              break;
          }

          // 确定喜忌神
          if (tongdang_score <= 305) {
            xi = ri_gan.wuxing + ri_gan.shengwo;
            ji = ri_gan.wosheng + ri_gan.woke + ri_gan.kewo;
          } else {
            xi = ri_gan.wosheng + ri_gan.woke + ri_gan.kewo;
            ji = ri_gan.wuxing + ri_gan.shengwo;
          }
        }

        return geju2;
      }

      // 显示结果
      function displayResults(gender) {
        // 八字信息
        document.getElementById("gender-info").textContent = gender;
        document.getElementById("nianzhu-info").textContent = nianzhu.name;
        document.getElementById("yuezhu-info").textContent = yuezhu.name;
        document.getElementById("rizhu-info").textContent = rizhu.name;
        document.getElementById("shizhu-info").textContent = shizhu.name;
        document.getElementById("rizhu1-info").textContent = rizhu1.name;
        document.getElementById("yueling-info").textContent =
          yuezhu.branch.name;

        // 合化情况
        const hehuaInfo = document.getElementById("hehua-info");
        if (hehuaLog.length > 0) {
          let hasHehua = false;
          for (let log of hehuaLog) {
            if (log.includes("成功")) {
              hasHehua = true;
              break;
            }
          }

          if (hasHehua) {
            hehuaInfo.innerHTML =
              "<p>存在合化情况，详细信息：</p><ul>" +
              hehuaLog.map((log) => `<li>${log}</li>`).join("") +
              "</ul>";
          } else {
            hehuaInfo.innerHTML = "<p>无合化情况</p>";
          }
        } else {
          hehuaInfo.innerHTML = "<p>无合化情况</p>";
        }

        // 五行分数
        const wuxingGrid = document.getElementById("wuxing-grid");
        wuxingGrid.innerHTML = "";
        for (let element in wuxing_score) {
          const item = document.createElement("div");
          item.className = "wu-xing-item";
          item.innerHTML = `
                    <div class="wu-xing-name">${element}</div>
                    <div class="wu-xing-score">${wuxing_score[element].score}</div>
                `;
          wuxingGrid.appendChild(item);
        }

        // 身强身弱分析
        const tongdang_score =
          wuxing_score[ri_gan.wuxing].score +
          wuxing_score[ri_gan.shengwo].score;
        const yidang_score = 610 - tongdang_score;

        document.getElementById("tongdang-elements").textContent =
          ri_gan.wuxing + ri_gan.shengwo;
        document.getElementById("tongdang-score").textContent = tongdang_score;
        document.getElementById("yidang-elements").textContent =
          ri_gan.wosheng + ri_gan.woke + ri_gan.kewo;
        document.getElementById("yidang-score").textContent = yidang_score;

        let shenqiangResult = "";
        if (tongdang_score <= 80) {
          shenqiangResult = "极弱";
        } else if (tongdang_score > 80 && tongdang_score <= 180) {
          shenqiangResult = "身弱";
        } else if (tongdang_score > 180 && tongdang_score <= 305) {
          shenqiangResult = "偏弱";
        } else if (tongdang_score > 305 && tongdang_score <= 440) {
          shenqiangResult = "偏强";
        } else if (tongdang_score > 440 && tongdang_score <= 570) {
          shenqiangResult = "身强";
        } else if (tongdang_score > 570) {
          shenqiangResult = "极强";
        }
        document.getElementById("shenqiang-result").textContent =
          shenqiangResult;

        // 格局分析
        let gejuResult = "";
        let baseGeju = geju; // 基础格局值
        let prefix = "";
        
        // 解析格局中的潜在和杂气信息
        if (geju > 19) {
          // 检查是否包含杂气信息
          if (geju % 2 === 0) {
            prefix += "杂气";
            baseGeju = geju / 2;
          }
          
          // 检查是否包含潜在信息
          if (baseGeju > 19 && baseGeju % 4 === 0) {
            prefix += "潜在";
            baseGeju = baseGeju / 4;
          }
        }
        
        switch (baseGeju) {
          case 1:
            gejuResult = prefix + "化木格";
            break;
          case 2:
            gejuResult = prefix + "化火格";
            break;
          case 3:
            gejuResult = prefix + "化土格";
            break;
          case 4:
            gejuResult = prefix + "化金格";
            break;
          case 5:
            gejuResult = prefix + "化水格";
            break;
          case 6:
            gejuResult = prefix + "专旺格";
            break;
          case 7:
            gejuResult = prefix + "从财格";
            break;
          case 8:
            gejuResult = prefix + "从杀格";
            break;
          case 9:
            gejuResult = prefix + "从儿格";
            break;
          case 10:
            gejuResult = prefix + "建禄格";
            break;
          case 11:
            gejuResult = prefix + "羊刃格";
            break;
          case 12:
            gejuResult = prefix + "正印格";
            break;
          case 13:
            gejuResult = prefix + "偏印格";
            break;
          case 14:
            gejuResult = prefix + "食神格";
            break;
          case 15:
            gejuResult = prefix + "伤官格";
            break;
          case 16:
            gejuResult = prefix + "正财格";
            break;
          case 17:
            gejuResult = prefix + "偏财格";
            break;
          case 18:
            gejuResult = prefix + "正官格";
            break;
          case 19:
            gejuResult = prefix + "七杀格";
            break;
          default:
            gejuResult = "未知格局";
        }
        document.getElementById("geju-result").textContent = gejuResult;

        // 喜忌神判定
        document.getElementById("xi-info").textContent = xi;
        document.getElementById("ji-info").textContent = ji;

        // 显示结果区域
        document.getElementById("result").style.display = "block";
      }

      // 初始化事件监听
      document.addEventListener("DOMContentLoaded", function () {
        const calculateBtn = document.getElementById("calculateBtn");
        calculateBtn.addEventListener("click", function () {
          const datetime = document.getElementById("datetime").value;
          const gender = document.getElementById("gender").value;

          if (datetime) {
            // 将 datetime-local 转换为可接受的格式
            const dateTimeStr = datetime.replace("T", " ");
            jisuan(dateTimeStr, gender);
          } else {
            alert("请输入出生时间");
          }
        });
      });
    </script>
  </body>
</html>
